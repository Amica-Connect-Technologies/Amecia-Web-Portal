{% extends 'custom_admin/base.html' %}

{% block page_title %}User Details{% endblock %}
{% block page_subtitle %}{{ user.email }}{% endblock %}

{% block extra_css %}
<style>
    .profile-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        overflow: hidden;
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .info-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        border: 1px solid #e2e8f0;
    }
    
    .info-row {
        display: grid;
        grid-template-columns: 150px 1fr;
        gap: 20px;
        padding: 12px 0;
        border-bottom: 1px solid #f1f5f9;
    }
    
    .info-row:last-child {
        border-bottom: none;
    }
    
    .info-label {
        color: #64748b;
        font-weight: 500;
    }
    
    .info-value {
        color: #334155;
        font-weight: 500;
    }
    
    .profile-image {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid white;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .document-link {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        color: #475569;
        text-decoration: none;
        transition: all 0.2s ease;
    }
    
    .document-link:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
        color: #1e293b;
    }
    
    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    @media (max-width: 768px) {
        .info-row {
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .action-buttons button, .action-buttons a {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Back Button -->
    <div>
        <a href="{% url 'custom_admin:manage_users' %}" class="flex items-center text-blue-600 hover:text-blue-800">
            <i class="fas fa-arrow-left mr-2"></i>
            Back to Users
        </a>
    </div>
    
    <!-- User Profile Header -->
    <div class="profile-header p-8">
        <div class="flex flex-col md:flex-row items-center md:items-start justify-between">
            <div class="flex flex-col md:flex-row items-center md:items-start space-y-4 md:space-y-0 md:space-x-6">
                <!-- Profile Image/Icon -->
                <div class="flex-shrink-0">
                    {% if profile_type == 'clinic' and profile.logo %}
                        <img src="{{ profile.logo.url }}" alt="{{ profile.clinic_name }}" class="profile-image">
                    {% elif profile_type == 'employer' and profile.company_logo %}
                        <img src="{{ profile.company_logo.url }}" alt="{{ profile.company_name }}" class="profile-image">
                    {% elif profile_type == 'job_seeker' and profile.profile_picture %}
                        <img src="{{ profile.profile_picture.url }}" alt="{{ profile.first_name }}" class="profile-image">
                    {% else %}
                        <div class="profile-image bg-white bg-opacity-20 flex items-center justify-center">
                            <span class="text-4xl font-bold">{{ user.email|first|upper }}</span>
                        </div>
                    {% endif %}
                </div>
                
                <!-- User Info -->
                <div class="text-center md:text-left">
                    <h1 class="text-3xl font-bold mb-2">
                        {% if profile_type == 'clinic' %}
                            {{ profile.clinic_name|default:user.email }}
                        {% elif profile_type == 'employer' %}
                            {{ profile.company_name|default:user.email }}
                        {% elif profile_type == 'job_seeker' %}
                            {{ profile.first_name }} {{ profile.last_name }}
                        {% else %}
                            {{ user.email }}
                        {% endif %}
                    </h1>
                    
                    <p class="text-blue-100 mb-4">{{ user.email }}</p>
                    
                    <div class="flex flex-wrap gap-2 justify-center md:justify-start">
                        <span class="status-badge {% if user.is_active %}bg-green-500{% else %}bg-red-500{% endif %}">
                            <i class="fas {% if user.is_active %}fa-check-circle{% else %}fa-times-circle{% endif %} mr-2"></i>
                            {{ user.is_active|yesno:"Active,Inactive" }}
                        </span>
                        
                        <span class="status-badge bg-blue-500">
                            <i class="fas fa-user-tag mr-2"></i>
                            {{ user.user_type|title }}
                        </span>
                        
                        {% if user.is_staff %}
                        <span class="status-badge bg-yellow-500">
                            <i class="fas fa-shield-alt mr-2"></i>
                            Staff
                        </span>
                        {% endif %}
                        
                        {% if user.is_superuser %}
                        <span class="status-badge bg-purple-500">
                            <i class="fas fa-crown mr-2"></i>
                            Super Admin
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="mt-6 md:mt-0">
                <div class="action-buttons">
                    <button onclick="toggleUserStatus('{{ user.id }}', {{ user.is_active|yesno:'true,false' }})"
                            class="px-4 py-2 {% if user.is_active %}bg-yellow-600 hover:bg-yellow-700{% else %}bg-green-600 hover:bg-green-700{% endif %} text-white rounded-lg flex items-center">
                        <i class="fas {% if user.is_active %}fa-toggle-off{% else %}fa-toggle-on{% endif %} mr-2"></i>
                        {{ user.is_active|yesno:"Deactivate,Activate" }}
                    </button>
                    
                    <button onclick="deleteUser('{{ user.id }}', '{{ user.email }}')"
                            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg flex items-center">
                        <i class="fas fa-trash mr-2"></i>
                        Delete User
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Account Information -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Account Information -->
            <div class="info-card">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-user-circle mr-2 text-blue-600"></i>
                    Account Information
                </h3>
                
                <div class="space-y-2">
                    <div class="info-row">
                        <span class="info-label">Email Address</span>
                        <span class="info-value">{{ user.email }}</span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">User Type</span>
                        <span class="info-value">
                            <span class="badge {% if user.user_type == 'clinic' %}badge-info{% elif user.user_type == 'employer' %}badge-warning{% else %}badge-success{% endif %}">
                                {{ user.user_type|title }}
                            </span>
                        </span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">Account Status</span>
                        <span class="info-value">
                            <span class="badge {% if user.is_active %}badge-success{% else %}badge-danger{% endif %}">
                                {{ user.is_active|yesno:"Active,Inactive" }}
                            </span>
                        </span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">Date Joined</span>
                        <span class="info-value">{{ user.date_joined|date:"F d, Y H:i" }}</span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">Last Login</span>
                        <span class="info-value">
                            {% if user.last_login %}
                                {{ user.last_login|date:"F d, Y H:i" }}
                                <span class="text-gray-500 text-sm ml-2">({{ user.last_login|timesince }} ago)</span>
                            {% else %}
                                <span class="text-gray-400">Never logged in</span>
                            {% endif %}
                        </span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">Terms Agreed</span>
                        <span class="info-value">
                            {% if user.agree_to_terms %}
                                <span class="text-green-600 flex items-center">
                                    <i class="fas fa-check-circle mr-2"></i>Yes
                                </span>
                            {% else %}
                                <span class="text-red-600 flex items-center">
                                    <i class="fas fa-times-circle mr-2"></i>No
                                </span>
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Profile Information -->
            {% if profile %}
            <div class="info-card">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    {% if profile_type == 'clinic' %}
                        <i class="fas fa-hospital mr-2 text-blue-600"></i>
                        Clinic Information
                    {% elif profile_type == 'employer' %}
                        <i class="fas fa-building mr-2 text-green-600"></i>
                        Company Information
                    {% elif profile_type == 'job_seeker' %}
                        <i class="fas fa-user-md mr-2 text-purple-600"></i>
                        Professional Information
                    {% endif %}
                </h3>
                
                <div class="space-y-2">
                    {% if profile_type == 'clinic' %}
                        <!-- Clinic Profile -->
                        <div class="info-row">
                            <span class="info-label">Clinic Name</span>
                            <span class="info-value">{{ profile.clinic_name }}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Clinic Type</span>
                            <span class="info-value">{{ profile.clinic_type|default:"Not specified" }}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">License Number</span>
                            <span class="info-value">{{ profile.license_number|default:"Not provided" }}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Doctors Count</span>
                            <span class="info-value">{{ profile.number_of_doctors|default:"0" }}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Phone</span>
                            <span class="info-value">{{ profile.phone|default:"Not provided" }}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Website</span>
                            <span class="info-value">
                                {% if profile.website %}
                                    <a href="{{ profile.website }}" target="_blank" class="text-blue-600 hover:text-blue-800">
                                        {{ profile.website }}
                                    </a>
                                {% else %}
                                    Not provided
                                {% endif %}
                            </span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Address</span>
                            <span class="info-value">{{ profile.address|default:"Not provided" }}</span>
                        </div>
                        
                        {% if profile.description %}
                        <div class="info-row">
                            <span class="info-label">Description</span>
                            <span class="info-value">{{ profile.description|linebreaks }}</span>
                        </div>
                        {% endif %}
                        
                        {% if profile.services %}
                        <div class="info-row">
                            <span class="info-label">Services</span>
                            <span class="info-value">{{ profile.services|linebreaks }}</span>
                        </div>
                        {% endif %}
                        
                    {% elif profile_type == 'employer' %}
                        <!-- Employer Profile -->
                        <div class="info-row">
                            <span class="info-label">Company Name</span>
                            <span class="info-value">{{ profile.company_name }}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Contact Person</span>
                            <span class="info-value">{{ profile.contact_person }}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Industry</span>
                            <span class="info-value">{{ profile.industry|default:"Not specified" }}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Company Size</span>
                            <span class="info-value">{{ profile.company_size|default:"Not specified" }}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Phone</span>
                            <span class="info-value">{{ profile.phone|default:"Not provided" }}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Website</span>
                            <span class="info-value">
                                {% if profile.website %}
                                    <a href="{{ profile.website }}" target="_blank" class="text-blue-600 hover:text-blue-800">
                                        {{ profile.website }}
                                    </a>
                                {% else %}
                                    Not provided
                                {% endif %}
                            </span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Address</span>
                            <span class="info-value">{{ profile.address|default:"Not provided" }}</span>
                        </div>
                        
                        {% if profile.description %}
                        <div class="info-row">
                            <span class="info-label">Description</span>
                            <span class="info-value">{{ profile.description|linebreaks }}</span>
                        </div>
                        {% endif %}
                        
                    {% elif profile_type == 'job_seeker' %}
                        <!-- Job Seeker Profile -->
                        <div class="info-row">
                            <span class="info-label">Full Name</span>
                            <span class="info-value">{{ profile.first_name }} {{ profile.last_name }}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Profession</span>
                            <span class="info-value">{{ profile.profession|default:"Not specified" }}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Experience</span>
                            <span class="info-value">{{ profile.experience_years|default:"0" }} years</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Date of Birth</span>
                            <span class="info-value">
                                {% if profile.date_of_birth %}
                                    {{ profile.date_of_birth|date:"F d, Y" }}
                                {% else %}
                                    Not provided
                                {% endif %}
                            </span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Phone</span>
                            <span class="info-value">{{ profile.phone|default:"Not provided" }}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Address</span>
                            <span class="info-value">{{ profile.address|default:"Not provided" }}</span>
                        </div>
                        
                        {% if profile.education %}
                        <div class="info-row">
                            <span class="info-label">Education</span>
                            <span class="info-value">{{ profile.education|linebreaks }}</span>
                        </div>
                        {% endif %}
                        
                        {% if profile.skills %}
                        <div class="info-row">
                            <span class="info-label">Skills</span>
                            <span class="info-value">{{ profile.skills|linebreaks }}</span>
                        </div>
                        {% endif %}
                    {% endif %}
                    
                    <!-- Profile Dates -->
                    <div class="info-row">
                        <span class="info-label">Profile Created</span>
                        <span class="info-value">{{ profile.created_at|date:"F d, Y H:i" }}</span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">Last Updated</span>
                        <span class="info-value">{{ profile.updated_at|date:"F d, Y H:i" }}</span>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- No Profile Warning -->
            <div class="info-card bg-yellow-50 border-yellow-200">
                <div class="flex items-start">
                    <i class="fas fa-exclamation-triangle text-yellow-600 text-xl mr-3 mt-1"></i>
                    <div>
                        <h3 class="text-lg font-semibold text-yellow-800 mb-2">No Profile Created</h3>
                        <p class="text-yellow-700">
                            This user hasn't created a {{ user.user_type|title }} profile yet.
                            They need to complete their profile to access all features.
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Right Column: Quick Actions & Documents -->
        <div class="space-y-6">
            <!-- Quick Actions -->
            <div class="info-card">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Actions</h3>
                <div class="space-y-3">
                    {% if user.is_active %}
                    <button onclick="toggleUserStatus('{{ user.id }}', true)"
                            class="w-full px-4 py-3 bg-yellow-50 border border-yellow-200 text-yellow-700 rounded-lg hover:bg-yellow-100 flex items-center justify-center">
                        <i class="fas fa-user-slash mr-2"></i>
                        Deactivate Account
                    </button>
                    {% else %}
                    <button onclick="toggleUserStatus('{{ user.id }}', false)"
                            class="w-full px-4 py-3 bg-green-50 border border-green-200 text-green-700 rounded-lg hover:bg-green-100 flex items-center justify-center">
                        <i class="fas fa-user-check mr-2"></i>
                        Activate Account
                    </button>
                    {% endif %}
                    
                    <button onclick="sendResetEmail('{{ user.email }}')"
                            class="w-full px-4 py-3 bg-blue-50 border border-blue-200 text-blue-700 rounded-lg hover:bg-blue-100 flex items-center justify-center">
                        <i class="fas fa-key mr-2"></i>
                        Send Password Reset
                    </button>
                    
                    <button onclick="impersonateUser('{{ user.id }}')"
                            class="w-full px-4 py-3 bg-purple-50 border border-purple-200 text-purple-700 rounded-lg hover:bg-purple-100 flex items-center justify-center">
                        <i class="fas fa-user-secret mr-2"></i>
                        Impersonate User
                    </button>
                    
                    <button onclick="deleteUser('{{ user.id }}', '{{ user.email }}')"
                            class="w-full px-4 py-3 bg-red-50 border border-red-200 text-red-700 rounded-lg hover:bg-red-100 flex items-center justify-center">
                        <i class="fas fa-trash mr-2"></i>
                        Delete Account
                    </button>
                </div>
            </div>
            
            <!-- Documents -->
            {% if profile and profile_type == 'job_seeker' %}
            <div class="info-card">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Documents</h3>
                <div class="space-y-3">
                    {% if profile.resume %}
                    <a href="{{ profile.resume.url }}" target="_blank" class="document-link w-full justify-center">
                        <i class="fas fa-file-pdf mr-2 text-red-500"></i>
                        View Resume
                    </a>
                    {% endif %}
                    
                    {% if profile.certifications %}
                    <a href="{{ profile.certifications.url }}" target="_blank" class="document-link w-full justify-center">
                        <i class="fas fa-certificate mr-2 text-blue-500"></i>
                        View Certifications
                    </a>
                    {% endif %}
                    
                    {% if not profile.resume and not profile.certifications %}
                    <p class="text-gray-500 text-center py-4">No documents uploaded</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            {% if profile and profile_type == 'clinic' %}
            <div class="info-card">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Clinic Documents</h3>
                <div class="space-y-3">
                    {% if profile.logo %}
                    <a href="{{ profile.logo.url }}" target="_blank" class="document-link w-full justify-center">
                        <i class="fas fa-image mr-2 text-green-500"></i>
                        View Logo
                    </a>
                    {% endif %}
                    
                    {% if profile.license_document %}
                    <a href="{{ profile.license_document.url }}" target="_blank" class="document-link w-full justify-center">
                        <i class="fas fa-file-contract mr-2 text-blue-500"></i>
                        View License
                    </a>
                    {% endif %}
                    
                    {% if not profile.logo and not profile.license_document %}
                    <p class="text-gray-500 text-center py-4">No documents uploaded</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- System Info -->
            <div class="info-card">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">System Information</h3>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">User ID:</span>
                        <span class="font-mono text-gray-800">{{ user.id }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Profile ID:</span>
                        <span class="font-mono text-gray-800">
                            {% if profile %}{{ profile.id }}{% else %}N/A{% endif %}
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Last Update:</span>
                        <span class="text-gray-800">
                            {% if profile %}
                                {{ profile.updated_at|timesince }} ago
                            {% else %}
                                N/A
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmationModal" class="modal">
    <div class="modal-content">
        <div class="text-center">
            <i class="fas fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
            <h3 id="modalTitle" class="text-xl font-semibold text-gray-800 mb-2"></h3>
            <p id="modalMessage" class="text-gray-600 mb-6"></p>
            <div class="flex space-x-3 justify-center">
                <button id="confirmAction" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Confirm
                </button>
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentAction = null;
    let currentUserId = null;
    let currentUserEmail = null;
    
    function toggleUserStatus(userId, isActive) {
        if (confirm('Are you sure you want to ' + (isActive ? 'deactivate' : 'activate') + ' this user?')) {
            fetch('/admin-custom/toggle-user/' + userId + '/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
        }
    }
    
    function deleteUser(userId, email) {
        currentAction = 'delete';
        currentUserId = userId;
        currentUserEmail = email;
        
        document.getElementById('modalTitle').textContent = 'Delete User';
        document.getElementById('modalMessage').textContent = 'Are you sure you want to delete user: ' + email + '? This action cannot be undone.';
        document.getElementById('confirmationModal').classList.add('show');
    }
    
    function sendResetEmail(email) {
        alert('Password reset email would be sent to: ' + email + '\n\n(This feature needs backend implementation)');
    }
    
    function impersonateUser(userId) {
        alert('Impersonation feature would be activated for user ID: ' + userId + '\n\n(This feature needs backend implementation)');
    }
    
    function closeModal() {
        document.getElementById('confirmationModal').classList.remove('show');
        currentAction = null;
        currentUserId = null;
        currentUserEmail = null;
    }
    
    document.getElementById('confirmAction').addEventListener('click', function() {
        if (currentAction === 'delete' && currentUserId) {
            fetch('/admin-custom/delete-user/' + currentUserId + '/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = "{% url 'custom_admin:manage_users' %}";
                } else {
                    alert('Error: ' + data.error);
                    closeModal();
                }
            })
            .catch(error => {
                alert('Error: ' + error);
                closeModal();
            });
        }
    });
    
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeModal();
        }
    });
</script>
{% endblock %}